<!-- security/users.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Users</title>
</head>
<body>
  <h2>Users</h2>

  <form id="createUserForm">
    <input id="username" placeholder="Username" required />
    <input id="password" type="password" placeholder="Password" required />
    <div id="groupCheckboxes"></div>
    <button type="submit">Create User</button>
  </form>

  <h3>Existing Users</h3>
  <ul id="userList"></ul>

<script>
async function fetchGroups() {
  const r = await fetch('/security/groups');
  return r.ok ? await r.json() : [];
}
async function fetchUsers() {
  const r = await fetch('/security/users');
  return r.ok ? await r.json() : [];
}

function renderGroupsCheckboxes(groups) {
  const container = document.getElementById("groupCheckboxes");
  container.innerHTML = "";
  groups.forEach(g => {
    const id = `group_${g.name}`;
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" id="${id}" value="${g.name}"> ${g.name}`;
    container.appendChild(label);
    container.appendChild(document.createElement("br"));
  });
}

function renderUsers(users) {
  const list = document.getElementById("userList");
  list.innerHTML = "";
  users.forEach(u => {
    const li = document.createElement("li");
    li.textContent = `${u.username} (groups: ${u.groups.join(", ")}) `;
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit groups";
    editBtn.onclick = () => editUserGroups(u.username, u.groups);
    li.appendChild(editBtn);
    list.appendChild(li);
  });
}

async function init() {
  const groups = await fetchGroups();
  renderGroupsCheckboxes(groups);
  const users = await fetchUsers();
  renderUsers(users);
}

document.getElementById("createUserForm").onsubmit = async (e) => {
  e.preventDefault();
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const chosen = Array.from(document.querySelectorAll("#groupCheckboxes input[type=checkbox]:checked")).map(i => i.value);

  const resp = await fetch('/security/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password, groups: chosen })
  });
  if (resp.ok) {
    document.getElementById("username").value = "";
    document.getElementById("password").value = "";
    const users = await fetchUsers();
    renderUsers(users);
  } else {
    alert('Create user failed: ' + (await resp.text()));
  }
};

async function editUserGroups(username, currentGroups) {
  const newGroups = prompt("Comma separated groups for " + username, currentGroups.join(","));
  if (newGroups === null) return;
  const groupsArr = newGroups.split(",").map(s => s.trim()).filter(Boolean);
  const resp = await fetch(`/security/users/${encodeURIComponent(username)}/groups`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ groups: groupsArr })
  });
  if (resp.ok) {
    const users = await fetchUsers();
    renderUsers(users);
  } else {
    alert('Update failed: ' + (await resp.text()));
  }
}

init();
</script>
</body>
</html>
