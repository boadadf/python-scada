<!-- security/groups.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Groups</title>
</head>
<body>
  <h2>Groups</h2>

  <form id="createGroupForm">
    <input id="groupName" placeholder="Group name" required />
    <button type="submit">Create Group</button>
  </form>

  <h3>Existing Groups</h3>
  <ul id="groupList"></ul>

<script>
async function fetchGroups() {
  const r = await fetch('/security/groups');
  return r.ok ? await r.json() : [];
}
async function fetchEndpoints() {
  const r = await fetch('/security/endpoints');
  return r.ok ? await r.json() : [];
}

function renderGroups(groups) {
  const list = document.getElementById("groupList");
  list.innerHTML = "";
  groups.forEach(g => {
    const li = document.createElement("li");
    li.textContent = `${g.name} (permissions: ${g.permissions.join(", ")}) `;
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit permissions";
    editBtn.onclick = () => showEditPermissions(g.name, g.permissions);
    li.appendChild(editBtn);
    list.appendChild(li);
  });
}

async function init() {
  const g = await fetchGroups();
  renderGroups(g);
  window._endpoints = await fetchEndpoints();
}

document.getElementById("createGroupForm").onsubmit = async (e) => {
  e.preventDefault();
  const name = document.getElementById("groupName").value;
  const resp = await fetch('/security/groups', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, permissions: [] })
  });
  if (resp.ok) {
    document.getElementById("groupName").value = "";
    const groups = await fetchGroups();
    renderGroups(groups);
  } else {
    alert('Create group failed: ' + (await resp.text()));
  }
};

async function showEditPermissions(groupName, currentPermissions) {
  window._endpoints = await fetchEndpoints();
  const available = window._endpoints || [];
  const newPerms = prompt("Permissions (comma separated). Available: " + available.join(", "), currentPermissions.join(", "));
  if (newPerms === null) return;
  const perms = newPerms.split(",").map(s => s.trim()).filter(Boolean);
  const resp = await fetch(`/security/groups/${encodeURIComponent(groupName)}/permissions`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ permissions: perms })
  });
  if (resp.ok) {
    const groups = await fetchGroups();
    renderGroups(groups);
  } else {
    alert('Update failed: ' + (await resp.text()));
  }
}

init();
</script>
</body>
</html>
