<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Groups</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h2>Groups</h2>

<form id="createGroupForm">
  <input id="groupName" placeholder="Group name" required />
  <button type="submit">Create Group</button>
</form>

<h3>Existing Groups</h3>
<ul id="groupList"></ul>

<script>
const socket = io();

function fetchGroups() { socket.emit("security_get_groups"); }
function fetchEndpoints() { socket.emit("security_get_endpoints"); }

socket.on("security_groups", (groups) => {
  const list = document.getElementById("groupList");
  list.innerHTML = "";
  groups.forEach(g => {
    const li = document.createElement("li");
    li.textContent = `${g.name} (permissions: ${g.permissions.join(", ")}) `;
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit permissions";
    editBtn.onclick = () => showEditPermissions(g.name, g.permissions);
    li.appendChild(editBtn);
    list.appendChild(li);
  });
});

socket.on("security_endpoints", (endpoints) => {
  window._security_endpoints = endpoints;
});

function showEditPermissions(groupName, currentPermissions) {
  fetchEndpoints();
  const available = window._security_endpoints || [];
  const newPerms = prompt("Permissions (comma separated). Available: " + available.join(", "), currentPermissions.join(", "));
  if (newPerms !== null) {
    const perms = newPerms.split(",").map(s => s.trim()).filter(Boolean);
    socket.emit("security_update_group", { name: groupName, permissions: perms });
  }
}

document.getElementById("createGroupForm").onsubmit = (e) => {
  e.preventDefault();
  const name = document.getElementById("groupName").value;
  socket.emit("security_create_group", { name, permissions: [] });
  document.getElementById("groupName").value = "";
};

fetchEndpoints();
fetchGroups();
</script>
</body>
</html>
