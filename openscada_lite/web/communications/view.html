<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Driver Communications</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .driver-list { margin-top: 2em; }
        .driver-row { display: flex; align-items: center; margin-bottom: 1em; }
        .status-indicator {
            width: 16px; height: 16px; border-radius: 50%; display: inline-block;
            margin-right: 1em; border: 1px solid #888;
        }
        .status-online { background: #2ecc40; }
        .status-offline { background: #ff4136; }
        .driver-name { width: 120px; }
        .driver-actions button { margin-left: 1em; }
    </style>
</head>
<body>
    <h1>Driver Communications</h1>
    <div class="driver-list" id="driver-list"></div>

    <script>
        const socket = io();

        // Store driver statuses as an array of objects
        let driverStatusList = [];

        function renderDrivers() {
            const list = document.getElementById('driver-list');
            list.innerHTML = '';
            driverStatusList.forEach(driverObj => {
                const driver = driverObj.driver_name;
                const status = driverObj.status;
                const row = document.createElement('div');
                row.className = 'driver-row';

                const indicator = document.createElement('span');
                indicator.className = 'status-indicator ' +
                    (status === 'online' || status === 'connect' ? 'status-online' : 'status-offline');

                const name = document.createElement('span');
                name.className = 'driver-name';
                name.textContent = driver;

                const statusText = document.createElement('span');
                statusText.textContent = (status === 'online' || status === 'connect') ? 'Online' : 'Offline';

                const actions = document.createElement('span');
                actions.className = 'driver-actions';

                // Enable/disable buttons based on current status
                const btnOnline = document.createElement('button');
                btnOnline.textContent = 'Set Online';
                btnOnline.disabled = (status === 'online' || status === 'connect');
                btnOnline.onclick = () => setDriverStatus(driver, 'connect');

                const btnOffline = document.createElement('button');
                btnOffline.textContent = 'Set Offline';
                btnOffline.disabled = (status === 'offline' || status === 'disconnect');
                btnOffline.onclick = () => setDriverStatus(driver, 'disconnect');

                actions.appendChild(btnOnline);
                actions.appendChild(btnOffline);

                row.appendChild(indicator);
                row.appendChild(name);
                row.appendChild(statusText);
                row.appendChild(actions);

                list.appendChild(row);
            });
        }

        function setDriverStatus(driver, status) {
            socket.emit('communication_send_driverconnectcommand', { driver_name: driver, status: status });
        }

        // Listen for all driver statuses (initial state)
        socket.on('communication_initial_state', function(data) {
            console.log("Initial driver statuses:", data);
            driverStatusList = data; // data is now an array
            renderDrivers();
        });

        // Listen for individual driver status updates
        socket.on('communication_driverconnectstatus', function(data) {
            if (data.driver_name && data.status) {
                // Update the status in the array
                let found = false;
                for (let i = 0; i < driverStatusList.length; i++) {
                    if (driverStatusList[i].driver_name === data.driver_name) {
                        driverStatusList[i].status = data.status;
                        found = true;
                        break;
                    }
                }
                // If not found, add new driver
                if (!found) {
                    driverStatusList.push({ driver_name: data.driver_name, status: data.status });
                }
                renderDrivers();
            }
        });

        // Request initial status on connect
        socket.on('connect', function() {
            socket.emit('communication_subscribe_live_feed');
        });
    </script>
</body>
</html>