<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tag List</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <h2>Tag List</h2>
    <table id="tag-table">
        <thead>
            <tr>
                <th>Tag</th>
                <th>Value</th>
                <th>Quality</th>
                <th>Timestamp</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Tag rows will be inserted here -->
        </tbody>
    </table>
    <script>
    const socket = io();
    const tagTableBody = document.querySelector('#tag-table tbody');
    const tags = {};

    function updateTagRow(tag) {
        let rowId = 'tag-' + tag.datapoint_identifier.replace(/[^a-zA-Z0-9]/g, '_');
        let row = document.getElementById(rowId);
        let valueDisplay = (tag.value === undefined || tag.value === null || tag.value === '') ? 'None' : tag.value;

        if (!row) {
            row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td>${tag.datapoint_identifier}</td>
                <td><input type="text" value="${valueDisplay}" /></td>
                <td class="quality"></td>
                <td class="timestamp"></td>
                <td><button>Update</button></td>
            `;
            tagTableBody.appendChild(row);

            // Update on Enter key
            row.querySelector('input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    sendUpdate(tag.datapoint_identifier, this.value);
                }
            });

            // Update on button click
            row.querySelector('button').addEventListener('click', function() {
                const val = row.querySelector('input').value;
                sendUpdate(tag.datapoint_identifier, val);
            });
        }

        // Always refresh fields
        row.querySelector('input').value = valueDisplay;
        row.querySelector('.quality').textContent = tag.quality ?? 'None';
        row.querySelector('.timestamp').textContent = tag.timestamp ?? 'None';
    }

    async function sendUpdate(datapoint_identifier, value) {
        try {                             
            const response = await fetch('/datapoint_send_rawtagupdatemsg', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Backend expects username (from login/session)
                    'X-User': localStorage.getItem('username') || ''
                },
                body: JSON.stringify({
                    datapoint_identifier: datapoint_identifier,
                    value: value,
                    quality: "good"
                })
            });

            const result = await response.json();
            if (response.ok) {
                console.log("Update successful:", result);
            } else {
                alert("Update failed: " + result.reason);
            }
        } catch (err) {
            console.error("Update request failed", err);
        }
    }

    socket.on('connect', () => {
        socket.emit('datapoint_subscribe_live_feed');
    });

    socket.on('datapoint_initial_state', function(tagList) {
        tagTableBody.innerHTML = '';
        tagList.forEach(tag => {
            tags[tag.datapoint_identifier] = tag;
            updateTagRow(tag);
        });
    });

    socket.on('datapoint_tagupdatemsg', function(tag) {
        tags[tag.datapoint_identifier] = tag;
        updateTagRow(tag);
    });
</script>
</body>
</html>