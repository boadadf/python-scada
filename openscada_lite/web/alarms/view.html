<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Active Alarms</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <h2>Active Alarms</h2>
    <table id="alarm-table">
        <thead>
            <tr>
                <th>Datapoint</th>
                <th>Activation Time</th>
                <th>Deactivation Time</th>
                <th>Acknowledge Time</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Alarm rows will be inserted here -->
        </tbody>
    </table>
    <script>
        const socket = io();
        const alarmTableBody = document.querySelector('#alarm-table tbody');
        const alarms = {};

        function formatTime(val) {
            return val ? val : 'None';
        }

        function updateAlarmRow(alarm) {
            const id = alarm.alarm_occurrence_id || (alarm.datapoint_identifier + '@' + alarm.activation_time);
            const rowId = 'alarm-' + id.replace(/[^a-zA-Z0-9]/g, '_');

            // Finished: both deactivation_time and acknowledge_time are set
            if (alarm.deactivation_time && alarm.acknowledge_time) {
                removeAlarmRow(id);
                delete alarms[id];
                return;
            }

            let row = document.getElementById(rowId);
            if (!row) {
                row = document.createElement('tr');
                row.id = rowId;
                row.innerHTML = `
                    <td>${alarm.datapoint_identifier}</td>
                    <td class="activation_time"></td>
                    <td class="deactivation_time"></td>
                    <td class="acknowledge_time"></td>
                    <td><button>Ack</button></td>
                `;
                alarmTableBody.appendChild(row);

                row.querySelector('button').addEventListener('click', function() {
                    sendAck(id);
                });
            }
            row.querySelector('.activation_time').textContent = formatTime(alarm.activation_time);
            row.querySelector('.deactivation_time').textContent = formatTime(alarm.deactivation_time);
            row.querySelector('.acknowledge_time').textContent = formatTime(alarm.acknowledge_time);
        }

        function removeAlarmRow(id) {
            const rowId = 'alarm-' + id.replace(/[^a-zA-Z0-9]/g, '_');
            const row = document.getElementById(rowId);
            if (row) row.remove();
        }

        // âœ… Replaced socket.emit with fetch POST
        async function sendAck(alarm_occurrence_id) {
            try {
                const response = await fetch('/alarm_send_ackalarmmsg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User': localStorage.getItem('username') || ''
                    },
                    body: JSON.stringify({
                        alarm_occurrence_id: alarm_occurrence_id
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    console.log("Ack sent successfully:", result);
                } else {
                    alert("Ack failed: " + result.reason);
                }
            } catch (err) {
                console.error("Failed to send ack", err);
            }
        }

        function checkAlarmsAckStatus() {
            // If any alarm in alarms is NOT acknowledged, send RaiseAlert
            const hasUnack = Object.values(alarms).some(alarm => !alarm.acknowledge_time);
            if (hasUnack) {
                window.parent.postMessage('RaiseAlert:Alarms', '*');
            } else {
                window.parent.postMessage('LowerAlert:Alarms', '*');
            }
        }

        socket.on('connect', () => {
            socket.emit('alarm_subscribe_live_feed');
        });

        socket.on('alarm_initial_state', function(alarmList) {
            alarmTableBody.innerHTML = '';
            const list = Array.isArray(alarmList) ? alarmList : (alarmList ? [alarmList] : []);
            for (const alarm of list) {
                const id = alarm.alarm_occurrence_id || (alarm.datapoint_identifier + '@' + alarm.activation_time);
                alarms[id] = alarm;
                updateAlarmRow(alarm);
            }
            checkAlarmsAckStatus();
        });

        socket.on('alarm_alarmupdatemsg', function(alarmList) {
            const list = Array.isArray(alarmList) ? alarmList : (alarmList ? [alarmList] : []);
            for (const id in alarms) {
                removeAlarmRow(id);
            }
            Object.keys(alarms).forEach(k => delete alarms[k]);
            for (const alarm of list) {
                const id = alarm.alarm_occurrence_id || (alarm.datapoint_identifier + '@' + alarm.activation_time);
                alarms[id] = alarm;
                updateAlarmRow(alarm);
            }
            checkAlarmsAckStatus();
        });
    </script>
</body>
</html>
